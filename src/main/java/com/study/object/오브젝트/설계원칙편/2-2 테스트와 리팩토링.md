# 🧠 리팩터링과 테스트 — 완전 숙지용 노트

---

## 1. 리팩터링의 정확한 정의

> **리팩터링이란
> 프로그램의 겉으로 드러나는 동작은 그대로 유지하면서
> 내부 구조를 더 이해하기 쉽고 유지보수하기 좋게 개선하는 작업이다**

* 기능 변경 ❌
* 설계 개선 ⭕

👉 **동작이 바뀌면 그건 리팩터링이 아니라 버그다**

---

## 2. 리팩터링이 두려운 이유의 본질

* 리팩터링은 내부 구조를 바꾸는 작업이다
* 내부 구조 변경은 **회귀(Regression) 버그**를 만들 가능성이 높다
* 실제로 많은 개발자가 리팩터링 후 장애를 경험한다

그래서 리팩터링은
기술적으로 어려워서가 아니라
**실수했을 때 영향이 크기 때문에 부담스럽다**

---

## 3. 리팩터링에는 반드시 안전장치가 필요하다

운영에 배포한 뒤 장애를 발견하는 것보다
**리팩터링 중에 문제를 발견하는 것이 훨씬 낫다**

👉 이 안전장치가 바로 **테스트(Test)** 다.

---

## 4. 리팩터링의 핵심 조건

> **리팩터링의 핵심은
> “동작이 변하지 않았음을 계속 확인하는 것”이다**

* 리팩터링 중 동작 변경 = Regression
* 동작이 유지되었는지 검증하지 않으면
  리팩터링은 도박이 된다

---

## 5. 회귀(Regression) 테스트의 의미

### 회귀 버그

* 이전에 정상 동작하던 기능이
* 변경 이후 깨진 상태

### 회귀 테스트

* 변경 이후에도
* **기존 기능이 계속 정상 동작하는지 검증하는 테스트**

👉 **리팩터링에는 회귀 테스트가 필수다**

---

## 6. 안전한 리팩터링의 절차 (고정 루틴)

```
1. 리팩터링 전에 테스트를 작성한다
2. 테스트가 성공하는 상태를 만든다
3. 리팩터링을 수행한다
4. 테스트를 다시 실행한다
5. 테스트가 성공하면 → 안전
6. 테스트가 실패하면 → 즉시 수정
```

> 리팩터링 전 성공한 테스트는
> 리팩터링 후에도 반드시 성공해야 한다

---

## 7. 테스트를 자주 실행해야 하는 이유

* 테스트 실행 주기가 짧을수록
* 마지막 변경 지점과 오류 원인이 가깝다
* 실패 원인을 빠르게 찾을 수 있다

👉 **테스트는 한 번에 몰아서가 아니라 자주 실행한다**

---

## 8. 테스트 가능성(Testability)은 설계의 문제다

> **테스트하기 어려운 코드는
> 대부분 설계도 나쁘다**

* 테스트 작성이 어렵다 → 설계 경고 신호
* 테스트가 쉽게 만들어진다 → 설계가 건강할 가능성 높음

👉 **테스트 가능성은 설계 품질의 지표다**

---

## 9. 테스트 관점에서 객체를 바라보는 법

객체를 테스트한다는 것은 결국:

> **입력을 주고 → 동작을 시키고 → 출력을 검증하는 과정**

### 테스트의 구성 요소

| 구분 | 의미                        |
| -- | ------------------------- |
| 입력 | 객체 상태, 메서드 파라미터, 받은 메시지   |
| 출력 | 상태 변화, 반환값, 외부 객체로 보낸 메시지 |

---

## 10. 객체는 반드시 메시지로만 협력해야 한다

* 객체 내부 상태 직접 접근 ❌
* 반드시 **메시지를 통해 요청**해야 한다
* 객체는 자신의 상태를 **스스로 변경**한다

👉 이 구조 덕분에
테스트도 객체와 협력하는 또 다른 객체처럼 작성할 수 있다

---

## 11. 상태 기반 검증 vs 상호작용 기반 검증

### 상태 기반 검증 (State-based)

* 객체의 상태를 변경한 뒤
* 변경된 상태를 조회해 검증

```
입력 → 상태 변경 → 상태 조회
```

### 상호작용 기반 검증 (Interaction-based)

* 다른 객체에게 메시지가
* 정상적으로 전달되었는지 검증

```
입력 → 메시지 전송 → 메시지 전달 여부 확인
```

👉 실제 테스트는 이 두 방식을 섞어서 사용한다

---

## 12. 테스트를 어렵게 만드는 설계 특징

* `System.in`, `System.out`에 직접 의존
* 객체 내부에서 `new`로 의존 객체 생성
* 입력과 출력이 명확하지 않음
* 외부 시스템과 강하게 결합됨
* 객체 상태를 외부에서 직접 만져야 함

👉 **입출력을 통제할 수 없으면 테스트도 통제할 수 없다**

---

## 13. 테스트 가능한 설계를 위한 최소 원칙

* 입력은 외부에서 주입 가능해야 한다
* 출력은 수집하고 검증할 수 있어야 한다
* 객체 생성 책임은 분리한다
* 외부 시스템과의 결합을 최소화한다

---

## 14. 테스트는 리팩터링의 센서다

* 테스트는 리팩터링 중 발생한 오류를 감지한다
* 동시에 **설계 품질을 평가하는 도구**다

> 테스트 작성이 어렵다면
> “이 코드는 리팩터링이 필요하다”는 신호다

---

## 15. 리팩터링과 테스트의 관계 요약

* 테스트 없이 리팩터링 ❌
* 테스트는 리팩터링의 안전망
* 테스트 가능성은 설계 품질의 척도
* 테스트가 쉬운 코드는 좋은 설계일 확률이 높다

---

## 16. 반드시 머리에 남겨야 할 문장들

* 리팩터링은 **동작을 유지한 채 구조를 바꾸는 일**
* 리팩터링에는 **회귀 테스트가 필수**
* 테스트 가능성은 **설계 품질의 지표**
* 테스트하기 어려운 코드는 **리팩터링 대상**
* 테스트는 검증 도구이자 **설계 신호**

---

## 17. 리팩터링 전에 스스로에게 던질 질문

* 지금 이 변경은 동작을 정말 유지하고 있는가?
* 테스트 없이 이 코드를 고칠 수 있는가?
* 입력과 출력을 내가 통제할 수 있는가?
* 테스트가 설계 개선 위치를 알려주고 있는가?

---